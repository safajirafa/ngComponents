// IMS Brogan
// Component: IMSPreferredView
// Version: 1.0.0
// Built date: 2013-10-09T12:03:44
var IMSPreferredView=angular.module("com.ims.preferredView",[]);IMSPreferredView.run(function($templateCache){$templateCache.put("preferredView.tmpl.html",'<div class="com-preferred-view"><button class="btn" ng-click="togglePopover()">{{btnLabel}}</button><div class="popover-container" ng-show="showPopover"><div class="span5"><div class="input-append"><input placeholder="save current view as..." type="text" ng-model="preferredViewTitle" class="span4" maxlength="58" ng-trim="true"><button class="btn btn-info" ng-click="savePreferredView()" ng-disabled="preferredViewTitle.length < 3">Save</button></div></div><table class="table"><tbody><thead ng-show="preferredViews.length > 0"><th>&nbsp;</th><th>Filter Name</th><th>Creation date</th><th>&nbsp;</th></thead><tr ng-repeat="pv in preferredViews | orderBy:pv.timestamp"><td><button class="btn btn-success" ng-click="restorePreferredView($event)" data-keys="{{pv.selectedKeys}}"><i class="icon-play"></i></button></td><td>{{pv.title}}</td><td>{{pv.timestamp | date:"short"}}</td><td><button class="btn btn-danger" ng-click="deletePreferredView($event)" data-guid="{{pv.guid}}" data-view-name="{{pv.viewName}}"><i class="icon-remove"></i></button></td></tr></tbody></table></div></div>')}),IMSPreferredView.factory("preferredViewServices",function($q,$http){var SERVICE_URL="PreferredViews.aspx";return{save:function(pv){var data=$.param({userId:pv.userId,viewName:pv.viewName,title:pv.title,selectedKeys:angular.toJson(pv.selectedKeys)}),config={headers:{"Content-Type":"application/x-www-form-urlencoded"}},dfd=$q.defer();return $http.post(SERVICE_URL+"/save",data,config).success(function(data){dfd.resolve(data)}).error(function(){throw"Preferred view could not be saved"}),dfd.promise},getList:function(viewName){var config={params:{viewName:viewName}},dfd=$q.defer();return $http.get(SERVICE_URL+"/getList",config).success(function(data){dfd.resolve(data)}).error(function(){throw dfd.reject(),"There was a problem loading your preferred views, please try again later"}),dfd.promise},"delete":function(guid,viewName){var data=$.param({guid:guid,viewName:viewName}),dfd=$q.defer(),config={headers:{"Content-Type":"application/x-www-form-urlencoded"}};return $http.post(SERVICE_URL+"/remove",data,config).success(function(data){dfd.resolve(data)}).error(function(){throw dfd.reject(),new Error("The preferred view was not deleted")}),dfd.promise}}}),IMSPreferredView.directive("preferredView",function(preferredViewServices){"use strict";return{restrict:"EA",replace:!0,scope:{btnLabel:"@",getPreferredViewObj:"&onSaving",onRestore:"&"},templateUrl:"preferredView.tmpl.html",link:function(scope,iElement){scope.showPopover=!1,scope.preferredViewTitle="",scope.preferredViews=[],scope.loadPreferredViews=function(viewName){preferredViewServices.getList(viewName).then(function(pvList){scope.preferredViews=pvList})},scope.togglePopover=function(){scope.showPopover=!scope.showPopover},scope.savePreferredView=function(){try{var pv=scope.getPreferredViewObj();pv.title=scope.preferredViewTitle,preferredViewServices.save(pv).then(function(){scope.preferredViewTitle="",scope.loadPreferredViews(pv.viewName)})}catch(err){alert("We are having problems saving preferred views at this time, please try again later"),console.log(err.message)}},scope.restorePreferredView=function(e){var dataKeys=e.currentTarget.getAttribute("data-keys");dataKeys=JSON.parse(dataKeys),scope.onRestore({selectedKeys:dataKeys}),scope.showPopover=!1},scope.deletePreferredView=function(e){try{var confirmDelete=window.confirm("Are you sure you want to permanently delete the selected item?");if(confirmDelete){var guid=e.currentTarget.getAttribute("data-guid"),viewName=e.currentTarget.getAttribute("data-view-name");preferredViewServices.delete(guid,viewName).then(function(){scope.loadPreferredViews(viewName)})}}catch(err){console.log(err.message),alert("We are having problems deleting the preferred view, try again later")}},scope.$on("preferredViews:load",function(event,viewName){try{scope.loadPreferredViews(viewName)}catch(err){console.log(err.message),alert("We are having problems getting the list of preferred views, please try again later")}}),iElement.find("input").bind("keypress",function(e){13===e.which&&scope.preferredViewTitle.length>=3&&scope.$apply(function(){scope.savePreferredView()})})}}});